# 🌍 NewsRag API - Complete Multi-Region Infrastructure

This Terraform configuration creates a **complete fresh multi-region deployment** of your NewsRag FastAPI application across 3 regions with full monitoring and alerting.

## 🏗️ Complete Infrastructure Overview

### 🌍 **Global Resources** (Shared)
| Resource | Name | Description |
|----------|------|-------------|
| **Resource Group** | `rg-newsraag-global-prod` | Houses all global resources |
| **Log Analytics** | `logs-newsraag-prod` | 30-day retention, PerGB2018 pricing |
| **Application Insights** | `insights-newsraag-prod` | Brand new monitoring solution |
| **Traffic Manager** | `tm-newsraag-prod` | Geographic routing with health checks |
| **Action Group** | `ag-newsraag-prod` | Email alerts to haripriyaveluchamy@aity.dev |

### 🇺🇸 **US Region** (`rg-newsraag-us-prod`)
| Resource | Name | Specs |
|----------|------|-------|
| **App Service Plan** | `plan-newsraag-us-prod` | Linux, Basic B1, Auto-scale 1-3 instances |
| **Web App** | `newsraag-us-prod` | Python 3.12, FastAPI ready |
| **Auto-scaling** | `autoscale-newsraag-us-prod` | CPU/Memory based scaling |
| **URL** | `newsraag-us-prod.azurewebsites.net` | Direct regional access |

### 🇪🇺 **Europe Region** (`rg-newsraag-eu-prod`)  
| Resource | Name | Specs |
|----------|------|-------|
| **App Service Plan** | `plan-newsraag-eu-prod` | Linux, Basic B1, Auto-scale 1-3 instances |
| **Web App** | `newsraag-eu-prod` | Python 3.12, FastAPI ready |
| **Auto-scaling** | `autoscale-newsraag-eu-prod` | CPU/Memory based scaling |
| **URL** | `newsraag-eu-prod.azurewebsites.net` | Direct regional access |

### 🇮🇳 **India Region** (`rg-newsraag-in-prod`)
| Resource | Name | Specs |
|----------|------|-------|
| **App Service Plan** | `plan-newsraag-in-prod` | Linux, Basic B1, Auto-scale 1-3 instances |
| **Web App** | `newsraag-in-prod` | Python 3.12, FastAPI ready |
| **Auto-scaling** | `autoscale-newsraag-in-prod` | CPU/Memory based scaling |
| **URL** | `newsraag-in-prod.azurewebsites.net` | Direct regional access |

## 🔔 **Comprehensive Monitoring** (15+ Alert Rules)

### **Performance Monitoring**
- **Response Time Alerts** (3): > 5 seconds per region
- **CPU Usage Alerts** (3): > 80% for 15 minutes per region
- **Memory Usage Alerts** (3): > 85% for 15 minutes per region

### **Reliability Monitoring**  
- **Error Rate Alerts** (3): > 10 HTTP 5xx errors in 5 minutes per region
- **Global Availability Alert** (1): < 90% uptime across all regions

### **Alert Destinations**
- **📧 Email**: haripriyaveluchamy@aity.dev
- **📱 Slack**: Optional (add webhook URL in config)

## 🌐 **Traffic Routing Strategy**

```
🌍 Global URL: newsraag-global-prod.trafficmanager.net
├── 🇺🇸 Americas → newsraag-us-prod.azurewebsites.net
├── 🇪🇺 Europe/MENA → newsraag-eu-prod.azurewebsites.net
└── 🇮🇳 Asia-Pacific → newsraag-in-prod.azurewebsites.net
```

### **Geographic Mappings**
- **🇺🇸 US Region**: US, CA, MX, Central America
- **🇪🇺 Europe Region**: Europe, Jordan, UAE, Saudi Arabia, Egypt, etc.
- **🇮🇳 India Region**: India, Pakistan, Bangladesh, Southeast Asia

## 💰 **Complete Cost Breakdown**

| Component | Quantity | Unit Cost | Monthly Total |
|-----------|----------|-----------|---------------|
| **App Service Plans (B1)** | 3 regions | $13.14 each | $39.42 |
| **Traffic Manager** | 1 profile | ~$0.54/million queries | $1-3 |
| **Application Insights** | 1 instance | ~$2.30/GB ingested | $10-20 |
| **Log Analytics** | 1 workspace | ~$2.30/GB ingested | $5-10 |
| **Alert Rules** | 15+ rules | Free tier | $0 |
| **Resource Groups** | 4 groups | Free | $0 |
| **Health Checks** | Included | Free | $0 |
| **📊 TOTAL ESTIMATED** |  |  | **$55-75/month** |

## ⚙️ **Pre-configured App Settings**

Each App Service gets these environment variables automatically:

### **Global Settings** (All Regions)
```bash
PYTHON_VERSION=3.12
ENVIRONMENT=production
WEBSITES_PORT=8000
API_HOST=0.0.0.0
API_PORT=8000
HEALTH_CHECK_ENABLED=true
```

### **Region-Specific Settings**
```bash
# US Region
DEPLOYMENT_REGION=us
AZURE_REGION=East US

# Europe Region  
DEPLOYMENT_REGION=eu
AZURE_REGION=West Europe

# India Region
DEPLOYMENT_REGION=in
AZURE_REGION=South India
```

### **Application Insights** (Auto-configured)
```bash
APPINSIGHTS_INSTRUMENTATIONKEY=<auto-generated>
APPLICATIONINSIGHTS_CONNECTION_STRING=<auto-generated>
```

## 🚀 **Deployment Instructions**

### **Prerequisites**
```bash
# 1. Azure CLI installed and logged in
az login
az account set --subscription "your-subscription-id"

# 2. Terraform installed (>= 1.0)
terraform --version
```

### **Deploy Infrastructure**
```bash
# Navigate to terraform directory
cd terraform/

# Initialize Terraform
terraform init

# Review the plan
terraform plan -var-file="environments/prod.tfvars"

# Deploy infrastructure
terraform apply -var-file="environments/prod.tfvars"
```

### **What Gets Created**
1. **4 Resource Groups** (1 global + 3 regional)
2. **1 Log Analytics Workspace** (30-day retention)
3. **1 Application Insights** (web application type)
4. **3 App Service Plans** (Basic B1, Linux)
5. **3 Linux Web Apps** (Python 3.12, FastAPI ready)
6. **3 Auto-scaling Rules** (CPU and memory based)
7. **1 Traffic Manager** (geographic routing)
8. **3 Traffic Manager Endpoints** (one per region)
9. **1 Action Group** (email notifications)
10. **15+ Metric Alerts** (comprehensive monitoring)

## 📊 **After Deployment - You Get**

### **🌍 Global Access**
- **Primary URL**: `https://newsraag-global-prod.trafficmanager.net`
- **Health Check**: `https://newsraag-global-prod.trafficmanager.net/health`

### **🔗 Regional Direct Access**
- **🇺🇸 US**: `https://newsraag-us-prod.azurewebsites.net`
- **🇪🇺 Europe**: `https://newsraag-eu-prod.azurewebsites.net` 
- **🇮🇳 India**: `https://newsraag-in-prod.azurewebsites.net`

### **📊 Monitoring Dashboard**
- **Azure Portal**: Application Insights → `insights-newsraag-prod`
- **Built-in Views**: Performance, Failures, Availability, Users
- **Custom Queries**: Multi-region analysis with Kusto

## 🔧 **Configuration Customization**

### **Add Your App Settings**
Edit `terraform/environments/prod.tfvars` and add:

```hcl
app_settings = {
  # Existing settings...
  
  # Your Azure OpenAI settings
  OPENAI_BASE_URL = "https://your-endpoint.openai.azure.com"
  AZURE_OPENAI_API_VERSION = "2024-02-01"
  AZURE_OPENAI_DEPLOYMENT = "your-deployment-name"
  
  # Your Qdrant settings
  QDRANT_URL = "your-qdrant-url"
  QDRANT_COLLECTION_NAME = "news_articles"
  
  # Add any other environment variables
  YOUR_CUSTOM_SETTING = "your-value"
}
```

### **Scale Up When Ready**
```hcl
# Change in prod.tfvars for production load
app_service_plan_sku = "S2"  # Standard tier
app_service_plan_tier = "Standard"
min_instances = 2
max_instances = 10
```

### **Add Slack Alerts**
```hcl
# Add your Slack webhook URL
slack_webhook_url = "https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK"
```

## 🏥 **Health Check Requirements**

Your FastAPI app must have a health endpoint at `/health` that returns HTTP 200:

```python
@app.get("/health")
def health_check():
    return {
        "status": "healthy",
        "region": os.environ.get('DEPLOYMENT_REGION', 'unknown'),
        "timestamp": datetime.utcnow().isoformat()
    }
```

## 🔄 **Next Steps After Infrastructure Deployment**

1. **✅ Verify URLs**: Test all 4 URLs (global + 3 regional)
2. **🚀 Deploy Your App**: Use GitHub Actions or Azure deployment
3. **📊 Monitor Performance**: Check Application Insights dashboards
4. **🔔 Test Alerts**: Verify email notifications work
5. **📈 Scale as Needed**: Upgrade tiers based on usage
6. **🌐 Add Custom Domain**: Configure your own domain name
7. **🔒 Add SSL Certificate**: Set up custom SSL certs

## 🎯 **This Creates a Production-Ready**

- ✅ **Globally distributed** FastAPI application
- ✅ **Auto-scaling** based on CPU and memory
- ✅ **Health check monitoring** with automatic failover
- ✅ **Comprehensive alerting** via email (and optional Slack)
- ✅ **Cost-optimized** Basic tier for starting (easily scalable)
- ✅ **Zero-dependency** setup (all resources created fresh)

**🚀 Ready to go global with your NewsRag API!**
